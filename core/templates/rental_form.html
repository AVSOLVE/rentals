{% extends "index.html" %}

{% block content %}
<form method="post" action=".">
  {% csrf_token %}

  <div id="conflict-message" class="alert alert-danger" style="display: none;"></div>

  {% if form.non_field_errors %}
  <div class="alert alert-danger">
    {% for error in form.non_field_errors %}
    <p class="text-center">{{ error | upper }}</p>
    {% endfor %}
  </div>
  {% endif %}

  {% if form.errors %}
  <div class="alert alert-danger">
    {% for field in form %}
    {% if field.errors %}
    <p class="text-center">{{ field.label | upper }}: {{ field.errors | join:", " }}</p>
    {% endif %}
    {% endfor %}
  </div>
  {% endif %}

  {% if user.is_superuser %}
  <div class="form-group">
    <label for="id_client">Professor</label>
    <select class="form-control" id="id_client" name="client">
      {% for user in form.fields.client.queryset %}
      <option value="{{ user.pk }}" {% if user.pk == form.initial.client.pk %} selected {% endif %}>
        {{ user.username | upper }}
      </option>
      {% endfor %}
    </select>
  </div>
  {% else %}
  <input type="hidden" name="client" value="{{ user.pk }}">
  {% endif %}

  <div class="form-group">
    <label for="id_item">Item</label>
    <select class="form-control" id="id_item" name="item" onchange="checkConflict()">
      {% for item in form.fields.item.queryset %}
      <option value="{{ item.pk }}" {% if item.pk == form.initial.item.pk %} selected {% endif %}>{{ item.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label for="id_date">Data</label>
    <input type="date" id="id_date" name="date" class="form-control" value="{{ form.initial.date|default:''|date:'Y-m-d' }}" onchange="checkConflict()">
  </div>

  <div class="form-group">
    <label for="id_period">Turno</label>
    <select class="form-control" id="id_period" name="period" onchange="checkConflict()">
      {% for value, label in form.fields.period.choices %}
      <option value="{{ value }}" {% if value == form.initial.period %} selected {% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label for="id_period_time">Aula</label>
    <select class="form-control" id="id_period_time" name="period_time" onchange="checkConflict()">
      {% for value, label in form.fields.period_time.choices %}
      <option value="{{ value }}" {% if value == form.initial.period_time %} selected {% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label for="id_room">Sala</label>
    <input type="text" id="id_room" name="room" class="form-control" placeholder="Digite a sala/turma"
      value="{{ form.initial.room|default:'' }}">
  </div>

  <div class="flex gap-2">
    <a href="{% url 'core:rental_list' %}" class="btn btn-warning w-full my-3">VOLTAR</a>
    <button type="submit" class="btn btn-success w-full my-3">SALVAR</button>
  </div>
</form>

<script>
function checkConflict() {
    const item = document.getElementById('id_item').value;
    const date = document.getElementById('id_date').value;
    const period = document.getElementById('id_period').value;
    const period_time = document.getElementById('id_period_time').value;

    if (item && date && period && period_time) {
        fetch(`/check-conflict/?item=${item}&date=${date}&period=${period}&period_time=${period_time}`)
            .then(response => response.json())
            .then(data => {
                const conflictMessage = document.getElementById('conflict-message');
                if (data.conflict) {
                    conflictMessage.style.display = 'block';
                    conflictMessage.textContent = data.message;
                } else {
                    conflictMessage.style.display = 'none';
                }
            });
    }
}
</script>
{% endblock %}
